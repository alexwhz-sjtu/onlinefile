<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æ•°æ®ç®¡ç†å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        .result-box {
            min-height: 200px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: Consolas, Monaco, monospace;
            font-size: 14px;
        }
        .header {
            background: linear-gradient(135deg, #FF69B4 0%, #EE82EE 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        .btn-action {
            margin: 5px;
            padding: 10px 20px;
        }
        .danger-zone {
            border-top: 2px dashed #dc3545;
            padding-top: 20px;
            margin-top: 30px;
        }
        #downloadExcelBtn {
            margin: 10px 0;
        }
        #downloadArea {
            /* display: none; ç§»é™¤é»˜è®¤éšè— */
            text-align: right;
            margin-top: 10px;
        }
        .insert-section input.form-control {
            font-size: 12px;
            padding: 4px 8px;
        }
        .insert-section label {
            font-size: 12px;
            font-weight: normal;
        }
        /* MAC é€‰æ‹©å™¨æ ·å¼ */
        .mac-selector-container {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background-color: #f8f9fa;
            margin-bottom: 15px;
        }
        .mac-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .mac-selector-title {
            margin: 0;
            font-size: 1rem;
            font-weight: bold;
        }
        .mac-selector-actions {
            display: flex;
            gap: 5px;
        }
        .mac-selector-actions .btn {
            padding: 4px 10px; /* è°ƒæ•´æŒ‰é’®å¤§å° */
            font-size: 0.875rem;
        }
        .mac-search-box {
            margin-bottom: 10px;
        }
        .mac-search-box input {
            font-size: 0.875rem; /* è°ƒæ•´æœç´¢æ¡†å­—ä½“ */
            padding: 6px 10px;
        }
        .mac-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* ç¨å¾®åŠ å¤§æ ‡ç­¾é—´è· */
            max-height: 180px; /* ç¨å¾®åŠ é«˜ï¼Œé¿å…æ»šåŠ¨å¤ªé¢‘ç¹ */
            overflow-y: auto;
            padding: 8px;
            border: 1px dashed #ced4da;
            border-radius: 6px;
            background-color: #ffffff;
        }
        .mac-tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            font-size: 0.875rem; /* 14pxï¼Œæ›´å¤§æ›´æ¸…æ™° */
            font-weight: 500;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 12px;
            cursor: pointer;
            min-width: 110px;
            transition: all 0.2s ease;
        }
        .mac-tag:hover {
            background-color: #d1d5d8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mac-tag.selected {
            background-color: #0d6efd; /* Bootstrap primary color */
            color: white;
            border-color: #0b5ed7;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        /* ä¸ºæ¯ä¸ªæ¨¡å—çš„ MAC é€‰æ‹©å™¨æ·»åŠ ä¸€ç‚¹åº•éƒ¨è¾¹è· */
        .card-body > .mac-selector-container {
            margin-top: 10px;
        }
        /* æ“ä½œæŒ‰é’®ç»„ç´§å‡‘æ’åˆ— */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: end;
        }
        .action-buttons .btn {
            white-space: nowrap;
        }
        /* æ—¶é—´è¾“å…¥æ¡†æ ·å¼ */
        .time-inputs {
            margin-top: 15px;
        }
        .time-inputs .form-label {
            font-size: 0.85rem;
        }
        .time-inputs .form-control {
            font-size: 0.85rem;
            padding: 4px 8px;
        }
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: #fff;
        }
        .chart-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        .chart-canvas-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .no-data-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }
        /* è°ƒè¯•åŒºåŸŸæ ·å¼ */
        .debug-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .debug-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .debug-content {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .debug-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .debug-item:last-child {
            border-bottom: none;
        }
        .debug-time {
            color: #0d6efd;
            font-weight: bold;
        }
        .debug-rssi {
            color: #dc3545;
            font-weight: bold;
        }
        /* æ•°æ®æˆªæ–­æç¤º */
        .data-truncated {
            color: #6c757d;
            font-style: italic;
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            text-align: center;
        }
        /* å›¾è¡¨æ§åˆ¶æŒ‰é’® */
        .chart-controls {
            text-align: center;
            margin-bottom: 15px;
        }
        .chart-controls .btn {
            margin: 0 5px;
            font-size: 0.875rem;
            padding: 4px 10px;
        }
        /* ä¸‹è½½çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .download-status {
            font-size: 0.875rem;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }
        .download-status.downloading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .download-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .download-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        /* çŠ¶æ€å›¾è¡¨çš„ Y è½´æ ‡ç­¾æ ·å¼ */
        .status-chart-legend {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .status-chart-legend span {
            display: inline-block;
            margin: 0 10px;
        }
        .status-chart-legend .dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .dot-bound { background-color: #28a745; } /* ç»¿è‰² */
        .dot-unbound { background-color: #dc3545; } /* çº¢è‰² */
        .dot-intransition { background-color: #6c757d; } /* ç°è‰² */
        /* Beacon è¾“å…¥æ¡†å®¹å™¨æ ·å¼ */
        .beacon-inputs-container {
            margin-top: 10px;
        }
        .beacon-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .beacon-input-row input {
            flex: 1;
            margin-right: 5px;
        }
        .beacon-input-row button {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<div class="header text-center">
    <div class="container">
        <h1>ğŸ“¡ è®¾å¤‡æ•°æ®ç®¡ç†å¹³å°</h1>
    </div>
</div>
<div class="container">
    <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ“Š æŸ¥è¯¢é€‰ä¸­è®¾å¤‡æ‰€æœ‰æ•°æ®</h5>
        </div>
        <div class="card-body">
            <div class="mac-selector-container" id="queryAllMacSelector">
                <div class="mac-selector-header">
                    <h6 class="mac-selector-title">é€‰æ‹© MAC åœ°å€ï¼ˆæ”¯æŒå¤šé€‰ï¼‰</h6>
                    <div class="mac-selector-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadMacListForCurrentSelector(this)">ğŸ”„ åŠ è½½</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, true)">å…¨é€‰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, false)">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="mac-search-box">
                    <input type="text" class="form-control form-control-sm" placeholder="æœç´¢ MAC..." oninput="filterTags(this)">
                </div>
                <div class="mac-tags-container"></div>
            </div>
            <div class="time-inputs">
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Beacon MACï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="form-control form-control-sm" placeholder="ä¾‹å¦‚ï¼š84C2E4000033" id="beaconMacFilter" value="84C2E4000033">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">èµ·å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="startTimeFilter">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ç»ˆæ­¢æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="endTimeFilter">
                    </div>
                </div>
            </div>
            <div class="action-buttons mt-3">
                <button onclick="querySelectedMacsAll(this)" class="btn btn-success btn-sm">
                    ğŸ“Š æŸ¥è¯¢é€‰ä¸­è®¾å¤‡æ‰€æœ‰æ•°æ® (æ˜¾ç¤ºå‰10æ¡)
                </button>
                <button onclick="downloadSelectedMacsAll(this)" class="btn btn-info btn-sm">
                    ğŸ“¥ ä¸‹è½½é€‰ä¸­è®¾å¤‡æ‰€æœ‰æ•°æ® (Excel)
                </button>
                <div id="downloadStatus" class="download-status" style="display:none;"></div>
            </div>
            <div class="form-text text-muted mt-2">ç‚¹å‡»â€œåŠ è½½â€æŒ‰é’®è·å– MAC åˆ—è¡¨ï¼Œå¯é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ª MAC åœ°å€è¿›è¡ŒæŸ¥è¯¢ã€‚æ”¯æŒæŒ‰ Beacon MAC å’Œæ—¶é—´èŒƒå›´ç­›é€‰ã€‚</div>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ“ˆ æŸ¥è¯¢é€‰ä¸­è®¾å¤‡æœ€æ–° N æ¡æ•°æ®</h5>
        </div>
        <div class="card-body">
            <div class="mac-selector-container" id="queryLatestMacSelector">
                <div class="mac-selector-header">
                    <h6 class="mac-selector-title">é€‰æ‹© MAC åœ°å€ (ä»…æ”¯æŒå•é€‰)</h6>
                    <div class="mac-selector-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadMacListForCurrentSelector(this)">ğŸ”„ åŠ è½½</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, false)">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="mac-search-box">
                    <input type="text" class="form-control form-control-sm" placeholder="æœç´¢ MAC..." oninput="filterTags(this)">
                </div>
                <div class="mac-tags-container"></div>
            </div>
            <div class="action-buttons align-items-end">
                <div>
                    <label class="form-label mb-0">è¿”å›æ¡æ•° N</label>
                    <input type="number" class="form-control form-control-sm" value="5" min="1" max="100" style="width: 100px;" id="latestNumInput">
                </div>
                <button onclick="querySelectedMacLatest(this)" class="btn btn-primary btn-sm">
                    ğŸ“ˆ æŸ¥è¯¢é€‰ä¸­è®¾å¤‡æœ€æ–° N æ¡
                </button>
            </div>
            <div class="form-text text-muted mt-2">ç‚¹å‡»â€œåŠ è½½â€æŒ‰é’®è·å– MAC åˆ—è¡¨ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ª MAC åœ°å€ï¼Œå¹¶è¾“å…¥è¦æŸ¥è¯¢çš„æ¡æ•°ã€‚</div>
        </div>
    </div>
    <!-- ä¿®æ”¹ï¼šç§»é™¤èµ·å§‹æ—¶é—´è¾“å…¥æ¡† -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ”— æŸ¥è¯¢åŠ¨åŠ›è½¦æœ€è¿‘ä¸€æ¬¡å·¥ä½œæ—¥å¿—</h5>
        </div>
        <div class="card-body">
            <div class="mac-selector-container" id="queryStatusMacSelector">
                <div class="mac-selector-header">
                    <h6 class="mac-selector-title">é€‰æ‹©åŠ¨åŠ›è½¦MAC åœ°å€</h6>
                    <div class="mac-selector-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadMacListForCurrentSelector(this)">ğŸ”„ åŠ è½½</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, true)">å…¨é€‰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, false)">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="mac-search-box">
                    <input type="text" class="form-control form-control-sm" placeholder="æœç´¢ MAC..." oninput="filterTags(this)">
                </div>
                <div class="mac-tags-container"></div>
            </div>
            <div class="time-inputs">
                <div class="row g-2">
                    <!-- ç§»é™¤ Beacon MAC è¾“å…¥æ¡† -->
                    <!-- ç§»é™¤ èµ·å§‹æ—¶é—´ è¾“å…¥æ¡† -->
                    <!-- ç§»é™¤ ç»ˆæ­¢æ—¶é—´ è¾“å…¥æ¡† -->
                </div>
            </div>
            <div class="action-buttons mt-3">
                <button onclick="queryConnectionStatus(this)" class="btn btn-warning btn-sm">
                    ğŸ”— æŸ¥è¯¢é€‰ä¸­åŸºç«™è¿æ¥çŠ¶æ€
                </button>
            </div>
            <div class="form-text text-muted mt-2">é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªåŸºç«™ MAC åœ°å€è¿›è¡Œè¿æ¥çŠ¶æ€æŸ¥è¯¢ã€‚</div>
        </div>
    </div>
    <!-- æ–°å¢ï¼šæŸ¥è¯¢åŠ¨åŠ›è½¦å·¥ä½œæ—¥å¿—æ—¶é—´èŒƒå›´ -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ“‹ æŸ¥è¯¢åŠ¨åŠ›è½¦å·¥ä½œæ—¥å¿—æ—¶é—´èŒƒå›´</h5>
        </div>
        <div class="card-body">
            <div class="mac-selector-container" id="queryWorkLogTimeRangeMacSelector">
                <div class="mac-selector-header">
                    <h6 class="mac-selector-title">é€‰æ‹©åŠ¨åŠ›è½¦MAC åœ°å€</h6>
                    <div class="mac-selector-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadMacListForCurrentSelector(this)">ğŸ”„ åŠ è½½</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, true)">å…¨é€‰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, false)">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="mac-search-box">
                    <input type="text" class="form-control form-control-sm" placeholder="æœç´¢ MAC..." oninput="filterTags(this)">
                </div>
                <div class="mac-tags-container"></div>
            </div>
            <div class="time-inputs">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Beacon MACï¼ˆå¯é€‰ï¼Œæ”¯æŒæ·»åŠ å¤šä¸ªï¼‰</label>
                        <div class="beacon-inputs-container" id="beaconInputsContainer">
                            <!-- åŠ¨æ€æ·»åŠ çš„è¾“å…¥æ¡†å°†æ”¾åœ¨è¿™é‡Œ -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addBeaconInput()">+</button>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">èµ·å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="workLogStartTimeFilter">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ç»ˆæ­¢æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="workLogEndTimeFilter">
                    </div>
                </div>
            </div>
            <div class="action-buttons mt-3">
                <button onclick="queryWorkLogTimeRange(this)" class="btn btn-info btn-sm">
                    ğŸ“‹ æŸ¥è¯¢é€‰ä¸­åŠ¨åŠ›è½¦å·¥ä½œæ—¥å¿—æ—¶é—´èŒƒå›´
                </button>
            </div>
            <div class="form-text text-muted mt-2">é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªåŠ¨åŠ›è½¦ MAC åœ°å€ï¼Œå¹¶æŒ‡å®šæ—¶é—´èŒƒå›´æŸ¥è¯¢å…¶å·¥ä½œæ—¥å¿—ï¼ˆç»‘å®š/è§£ç»‘çŠ¶æ€å˜åŒ–ï¼‰ã€‚å¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ª Beacon MAC åœ°å€è¿›è¡Œè¿‡æ»¤ã€‚</div>
        </div>
    </div>
    <!-- æ–°å¢ï¼šæŸ¥è¯¢æ— åŠ¨åŠ›è½¦æŸæ®µæ—¶é—´çš„æ”¶è´¹ -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ’° æŸ¥è¯¢æ— åŠ¨åŠ›è½¦æŸæ®µæ—¶é—´æ”¶è´¹</h5>
        </div>
        <div class="card-body">
            <div class="mac-selector-container" id="queryMoneyMacSelector">
                <div class="mac-selector-header">
                    <h6 class="mac-selector-title">é€‰æ‹©ä¸»è®¾å¤‡ MACï¼ˆå¯å¤šé€‰ï¼‰</h6>
                    <div class="mac-selector-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadMacListForCurrentSelector(this)">ğŸ”„ åŠ è½½</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, true)">å…¨é€‰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, false)">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="mac-search-box">
                    <input type="text" class="form-control form-control-sm" placeholder="æœç´¢ MAC..." oninput="filterTags(this)">
                </div>
                <div class="mac-tags-container"></div>
            </div>
            <div class="time-inputs">
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Beacon MACï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="form-control form-control-sm" id="moneyBeaconMac" placeholder="ä¾‹å¦‚ï¼š84C2E4000033">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">èµ·å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="moneyStartTime">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ç»ˆæ­¢æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="moneyEndTime">
                    </div>
                </div>
            </div>
            <div class="action-buttons mt-3">
                <button onclick="queryMoney(this)" class="btn btn-secondary btn-sm">
                    ğŸ’° æŸ¥è¯¢æ”¶è´¹
                </button>
            </div>
            <div class="form-text text-muted mt-2">é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªä¸»è®¾å¤‡ MACï¼Œå¯æŒ‡å®š Beacon MAC å’Œæ—¶é—´èŒƒå›´ï¼ŒæŸ¥è¯¢å¯¹åº”æ—¶é—´æ®µå†…çš„æ€»è´¹ç”¨ï¼ˆå•ä½ï¼šåˆ†æˆ–å…ƒï¼Œå–å†³äºåç«¯ï¼‰ã€‚</div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­è®¾å¤‡æ‰€æœ‰æ•°æ®</h5>
        </div>
        <div class="card-body">
            <div class="mac-selector-container" id="deleteMacSelector">
                <div class="mac-selector-header">
                    <h6 class="mac-selector-title">é€‰æ‹© MAC åœ°å€</h6>
                    <div class="mac-selector-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadMacListForCurrentSelector(this)">ğŸ”„ åŠ è½½</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, true)">å…¨é€‰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAllTags(this, false)">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="mac-search-box">
                    <input type="text" class="form-control form-control-sm" placeholder="æœç´¢ MAC..." oninput="filterTags(this)">
                </div>
                <div class="mac-tags-container"></div>
            </div>
            <div class="action-buttons">
                <button onclick="deleteSelectedMacsAll(this)" class="btn btn-danger btn-sm">
                    ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­è®¾å¤‡æ‰€æœ‰æ•°æ®
                </button>
            </div>
            <div class="form-text text-danger mt-2">âš ï¸ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼è¯·è°¨æ…é€‰æ‹©ã€‚</div>
        </div>
    </div>
    <div class="card mb-4 danger-zone">
        <div class="card-header bg-danger text-white">
            <h5>âš ï¸ å±é™©æ“ä½œåŒº</h5>
        </div>
        <div class="card-body">
            <p class="text-danger"><strong>æ³¨æ„ï¼š</strong>æ­¤æ“ä½œå°†æ¸…ç©ºæ•°æ®åº“ä¸­æ‰€æœ‰è®°å½•ï¼Œä¸å¯æ¢å¤ï¼</p>
            <button onclick="deleteAll()" class="btn btn-outline-danger btn-action">ğŸš¨ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5>ğŸ“¥ æ‰‹åŠ¨æ’å…¥æ–°è®°å½•</h5>
        </div>
        <div class="card-body insert-section">
            <div class="row g-2">
                <div class="col-md-3">
                    <label>v</label>
                    <input type="number" id="insertV" class="form-control form-control-sm" value="1" required>
                </div>
                <div class="col-md-3">
                    <label>ä¸»è®¾å¤‡ MAC</label>
                    <input type="text" id="insertMainMac" class="form-control form-control-sm" value="AB231100000F" required>
                </div>
                <div class="col-md-3">
                    <label>QCCID</label>
                    <input type="text" id="insertQccid" class="form-control form-control-sm" value="898604D2192220256819" required>
                </div>
                <div class="col-md-3">
                    <label>ç”µé‡</label>
                    <input type="number" id="insertBattery" class="form-control form-control-sm" value="88" required>
                </div>
                <div class="col-md-3">
                    <label>çº¬åº¦</label>
                    <input type="number" id="insertLat" class="form-control form-control-sm" value="0" step="0.000001" required>
                </div>
                <div class="col-md-3">
                    <label>ç»åº¦</label>
                    <input type="number" id="insertLon" class="form-control form-control-sm" value="0" step="0.000001" required>
                </div>
                <div class="col-md-3">
                    <label>æ—¶é—´ B</label>
                    <input type="text" id="insertTimeB" class="form-control form-control-sm" value="68BAFA40" required>
                </div>
                <div class="col-md-3">
                    <label>æ‰«æç±»å‹</label>
                    <input type="number" id="insertScanType" class="form-control form-control-sm" value="4" required>
                </div>
                <div class="col-md-3">
                    <label>æ‰«ææ—¶é—´</label>
                    <input type="text" id="insertTime" class="form-control form-control-sm" value="68BAFA3D" required>
                </div>
                <div class="col-md-3">
                    <label>Beacon MAC</label>
                    <input type="text" id="insertBeaconMac" class="form-control form-control-sm" value="84C2E4000033" required>
                </div>
                <div class="col-md-3">
                    <label>RSSI</label>
                    <input type="number" id="insertRssi" class="form-control form-control-sm" value="-65" required>
                </div>
                <div class="col-md-3">
                    <label>å¹¿æ’­æ•°æ®</label>
                    <input type="text" id="insertAdvData" class="form-control form-control-sm" value="FFFF0000000000000000000000000000000000000000000000000000000000" required>
                </div>
                <div class="col-12 mt-2">
                    <button onclick="insertData()" class="btn btn-primary btn-sm">ğŸš€ æ’å…¥æ•°æ®</button>
                    <span id="insertResult" class="ms-2"></span>
                </div>
            </div>
        </div>
    </div>
    <div id="chartsContainer" class="mt-4">
    </div>
    <h4>ğŸ“Š æ“ä½œç»“æœ</h4>
    <div id="downloadArea">
    </div>
    <div class="result-box" id="resultBox">
        ç­‰å¾…æ“ä½œ...
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const resultBox = document.getElementById('resultBox');
    const downloadArea = document.getElementById('downloadArea');
    const insertResult = document.getElementById('insertResult');
    const chartsContainer = document.getElementById('chartsContainer');
    const downloadStatus = document.getElementById('downloadStatus');
    let lastQueryData = null; // ç”¨äºæ˜¾ç¤ºçš„æ•°æ®
    let lastDownloadData = null; // ç”¨äºä¸‹è½½çš„æ•°æ®
    let globalAllMacs = []; // å…¨å±€ç¼“å­˜çš„ MAC åˆ—è¡¨
    let chartInstances = []; // å­˜å‚¨å›¾è¡¨å®ä¾‹
    let abortControllers = []; // å­˜å‚¨å½“å‰æ‰€æœ‰æ´»è·ƒè¯·æ±‚çš„æ§åˆ¶å™¨
    // è®¾ç½®åŸºç¡€URLï¼ˆæ ¹æ®ä½ çš„åç«¯åœ°å€è°ƒæ•´ï¼‰
    const API_BASE = 'http://101.133.172.181:8049';
    //const API_BASE = 'http://127.0.0.1:8049';
    // --- çŠ¶æ€æ˜ å°„å¸¸é‡ ---
    const STATUS_MAP = {
        'Bound': 3,
        'In Transition': 2,
        'Unbound': 1
    };
    const STATUS_COLOR = {
        'Bound': '#28a745', // ç»¿è‰²
        'In Transition': '#ffc107', // æ©™è‰²/é»„è‰²ï¼ˆä¸ç°è‰²ä½œåŒºåˆ†ï¼Œç”¨è­¦å‘Šè‰²ï¼‰
        'Unbound': '#dc3545' // çº¢è‰²
    };
    const STATUS_Y_LABELS = {
        1: 'Unbound (æœªç»‘å®š)',
        2: 'In Transition (è½¬æ¢ä¸­)',
        3: 'Bound (å·²ç»‘å®š)'
    };
    // --- é€šç”¨æ—¥æœŸæ—¶é—´æ ¼å¼åŒ–å‡½æ•° ---
    function formatDateTimeForBackend(localDateTime) {
        if (!localDateTime) return '';
        // localDateTime æ ¼å¼: "2024-06-01T10:30"
        const [datePart, timePart] = localDateTime.split('T');
        const [year, month, day] = datePart.split('-').map(Number);
        const [hours, minutes] = timePart.split(':').map(Number);
        // æ„é€ æœ¬åœ°æ—¶é—´ï¼ˆä¸ç»è¿‡ UTC è½¬æ¢ï¼‰
        const localDate = new Date(year, month - 1, day, hours, minutes, 0);
        // æ ¼å¼åŒ–ä¸º "YYYY-MM-DD HH:mm:ss"
        const pad = n => String(n).padStart(2, '0');
        return `${localDate.getFullYear()}-${pad(localDate.getMonth() + 1)}-${pad(localDate.getDate())} ${pad(localDate.getHours())}:${pad(localDate.getMinutes())}:${pad(localDate.getSeconds())}`;
    }
    // --- Beacon è¾“å…¥æ¡†ç®¡ç† ---
    let beaconInputCounter = 0; // ç”¨äºç”Ÿæˆå”¯ä¸€ID

    function addBeaconInput() {
        const container = document.getElementById('beaconInputsContainer');
        const inputRow = document.createElement('div');
        inputRow.className = 'beacon-input-row';

        const inputId = `beaconInput_${beaconInputCounter++}`;
        inputRow.innerHTML = `
            <input type="text" class="form-control form-control-sm" id="${inputId}" placeholder="ä¾‹å¦‚ï¼š84C2E4000033">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeBeaconInput(this)">-</button>
        `;
        container.appendChild(inputRow);
    }

    function removeBeaconInput(button) {
        const row = button.closest('.beacon-input-row');
        row.remove();
    }

    function getBeaconInputs() {
        const inputs = document.querySelectorAll('#beaconInputsContainer input');
        const values = [];
        inputs.forEach(input => {
            if (input.value.trim() !== '') {
                values.push(input.value.trim());
            }
        });
        return values;
    }

    // --- é€šç”¨ MAC é€‰æ‹©å™¨é€»è¾‘ ---
    // è·å–å½“å‰æ“ä½œæ¨¡å—çš„ MAC é€‰æ‹©å™¨å®¹å™¨
    function getCurrentMacSelector(btnOrElement) {
        // å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ .card æˆ– .mac-selector-container
        const card = btnOrElement.closest('.card, .mac-selector-container');
        if (card) {
            return card.querySelector('.mac-selector-container') || card;
        }
        return null;
    }
    // ä¸ºå½“å‰é€‰æ‹©å™¨åŠ è½½ MAC åˆ—è¡¨
    async function loadMacListForCurrentSelector(btn) {
        const selectorContainer = getCurrentMacSelector(btn);
        if (!selectorContainer) {
            console.error("æœªæ‰¾åˆ° MAC é€‰æ‹©å™¨å®¹å™¨");
            return;
        }
        const tagsContainer = selectorContainer.querySelector('.mac-tags-container');
        const searchInput = selectorContainer.querySelector('.mac-search-box input');
        const loadBtn = selectorContainer.querySelector('.mac-selector-actions .btn:first-child'); // å‡è®¾ç¬¬ä¸€ä¸ªæ˜¯åŠ è½½æŒ‰é’®
        // å¦‚æœå…¨å±€ç¼“å­˜ä¸ºç©ºï¼Œåˆ™ä»æœåŠ¡å™¨åŠ è½½
        if (globalAllMacs.length === 0) {
            try {
                loadBtn.disabled = true;
                loadBtn.textContent = 'åŠ è½½ä¸­...';
                resultBox.textContent = 'æ­£åœ¨åŠ è½½ MAC åˆ—è¡¨...';
                resultBox.className = 'result-box text-primary';
                const res = await axios.get(`${API_BASE}/mac-list`);
                if (res.data && Array.isArray(res.data)) {
                    globalAllMacs = res.data;
                    resultBox.textContent = `âœ… æˆåŠŸåŠ è½½ ${globalAllMacs.length} ä¸ª MAC åœ°å€ã€‚`;
                    resultBox.className = 'result-box text-success';
                } else {
                    throw new Error('è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (err) {
                console.error('åŠ è½½ MAC åˆ—è¡¨å¤±è´¥:', err);
                resultBox.textContent = `âŒ åŠ è½½å¤±è´¥ï¼š${err.message}`;
                resultBox.className = 'result-box text-danger';
                loadBtn.disabled = false;
                loadBtn.textContent = 'ğŸ”„ åŠ è½½';
                return;
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'ğŸ”„ åŠ è½½';
            }
        }
        // æ¸²æŸ“æ ‡ç­¾åˆ°å½“å‰é€‰æ‹©å™¨
        renderMacTags(tagsContainer, globalAllMacs);
        searchInput.disabled = false;
    }
    // æ¸²æŸ“ MAC æ ‡ç­¾
    function renderMacTags(container, macs) {
        container.innerHTML = '';
        macs.forEach(mac => {
            const tag = document.createElement('span');
            tag.className = 'mac-tag';
            tag.dataset.mac = mac;
            tag.innerHTML = `<span class="tag-text">${mac}</span>`;
            tag.onclick = function() {
                // å¦‚æœæ˜¯å•é€‰æ¨¡å¼ (å¦‚æŸ¥è¯¢æœ€æ–° N æ¡)ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªè¢«é€‰ä¸­
                const card = this.closest('.card');
                if (card.querySelector('#latestNumInput')) { // ç®€å•åˆ¤æ–­æ˜¯å¦ä¸ºå•é€‰æ¨¡å¼
                    const selected = container.querySelectorAll('.mac-tag.selected');
                    selected.forEach(t => {
                        if (t !== this) t.classList.remove('selected');
                    });
                }
                this.classList.toggle('selected');
            };
            container.appendChild(tag);
        });
    }
    // æœç´¢è¿‡æ»¤æ ‡ç­¾ (åœ¨å½“å‰é€‰æ‹©å™¨å†…)
    function filterTags(inputElement) {
        const term = inputElement.value.toLowerCase().trim();
        const selectorContainer = getCurrentMacSelector(inputElement);
        const tags = selectorContainer.querySelectorAll('.mac-tag');
        tags.forEach(tag => {
            const mac = tag.dataset.mac.toLowerCase();
            if (mac.includes(term)) {
                tag.style.display = '';
            } else {
                tag.style.display = 'none';
            }
        });
    }
    // è·å–å½“å‰é€‰æ‹©å™¨é€‰ä¸­çš„ MAC
    function getSelectedMacsFromSelector(selectorContainer) {
        const selectedTags = selectorContainer.querySelectorAll('.mac-tag.selected');
        return Array.from(selectedTags).map(tag => tag.dataset.mac);
    }
    // å…¨é€‰/æ¸…ç©ºå½“å‰é€‰æ‹©å™¨çš„æ ‡ç­¾
    function toggleSelectAllTags(btn, select) {
        const selectorContainer = getCurrentMacSelector(btn);
        const tags = selectorContainer.querySelectorAll('.mac-tag');
        tags.forEach(tag => {
            if (select) {
                tag.classList.add('selected');
            } else {
                tag.classList.remove('selected');
            }
        });
    }
    // --- å¯¼å‡ºä¸º Excel (ä½¿ç”¨ lastDownloadData) ---
    function exportToExcel() {
        if (!lastDownloadData || !Array.isArray(lastDownloadData) || lastDownloadData.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
            return;
        }
        const worksheet = XLSX.utils.json_to_sheet(lastDownloadData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "è®¾å¤‡æ•°æ®");
        XLSX.writeFile(workbook, `è®¾å¤‡æ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
    // --- æ¸…ç©ºæ‰€æœ‰æ•°æ® ---
    async function deleteAll() {
        if (!confirm('âš ï¸ è­¦å‘Šï¼ä½ å³å°†æ¸…ç©ºæ•°æ®åº“ä¸­æ‰€æœ‰è®°å½•ï¼æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
            return;
        }
        try {
            resultBox.textContent = 'æ­£åœ¨æ¸…ç©ºæ‰€æœ‰æ•°æ®...';
            resultBox.className = 'result-box text-primary';
            const res = await axios.delete(`${API_BASE}/delete/all`);
            resultBox.textContent = `âœ… ${res.data}`;
            resultBox.className = 'result-box text-success';
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';
            // æ¸…ç©ºå…¨å±€ç¼“å­˜
            globalAllMacs = [];
        } catch (err) {
            resultBox.textContent = `âŒ æ¸…ç©ºå¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
        }
    }
    // --- æ’å…¥æ•°æ® ---
    async function insertData() {
        const data = {
            v: parseInt(document.getElementById('insertV').value),
            mac: document.getElementById('insertMainMac').value.trim(),
            qccid: document.getElementById('insertQccid').value.trim(),
            battery: parseInt(document.getElementById('insertBattery').value),
            lat: parseFloat(document.getElementById('insertLat').value),
            lon: parseFloat(document.getElementById('insertLon').value),
            time_b: document.getElementById('insertTimeB').value.trim(),
            scan_type: parseInt(document.getElementById('insertScanType').value),
            time: document.getElementById('insertTime').value.trim(),
            beacon_mac: document.getElementById('insertBeaconMac').value.trim(),
            rssi: parseInt(document.getElementById('insertRssi').value),
            adv_data: document.getElementById('insertAdvData').value.trim()
        };
        if (!data.mac || !data.qccid || !data.time_b || !data.beacon_mac) {
            insertResult.className = 'text-danger';
            insertResult.textContent = 'âŒ è¯·å¡«å†™å¿…è¦å­—æ®µ';
            return;
        }
        insertResult.className = 'text-primary';
        insertResult.textContent = 'æ’å…¥ä¸­...';
        try {
            console.log('å‡†å¤‡æ’å…¥çš„æ•°æ®:', data);
            const res = await axios.post(`${API_BASE}/insert`, data, {
                headers: { 'Content-Type': 'application/json' }
            });
            insertResult.className = 'text-success';
            insertResult.textContent = 'âœ… ' + res.data;
            // æ’å…¥æˆåŠŸåï¼Œå¦‚æœå…¨å±€åˆ—è¡¨ä¸­æ²¡æœ‰è¿™ä¸ª MACï¼Œåˆ™æ·»åŠ 
            if (!globalAllMacs.includes(data.mac)) {
                globalAllMacs.push(data.mac);
            }
        } catch (err) {
            insertResult.className = 'text-danger';
            let errorMsg = 'æœªçŸ¥é”™è¯¯';
            if (err.response && err.response.data) {
                errorMsg = typeof err.response.data === 'object'
                    ? JSON.stringify(err.response.data, null, 2)
                    : err.response.data;
            } else if (err.message) {
                errorMsg = err.message;
            }
            insertResult.textContent = 'âŒ ' + errorMsg;
        }
    }
    // --- æŸ¥è¯¢é€‰ä¸­ MAC æ‰€æœ‰æ•°æ® (ç”¨äºæ˜¾ç¤ºå‰10æ¡) ---
    async function querySelectedMacsAll(btn) {
        const selectorContainer = getCurrentMacSelector(btn);
        const selected = getSelectedMacsFromSelector(selectorContainer);
        if (selected.length === 0) {
            alert('è¯·å…ˆåŠ è½½å¹¶å‹¾é€‰è‡³å°‘ä¸€ä¸ª MAC åœ°å€');
            return;
        }
        // è·å–é¢å¤–å‚æ•°
        const beaconMac = document.getElementById('beaconMacFilter').value.trim();
        const startTime = document.getElementById('startTimeFilter').value ? formatDateTimeForBackend(document.getElementById('startTimeFilter').value) : '';
        const endTime = document.getElementById('endTimeFilter').value ? formatDateTimeForBackend(document.getElementById('endTimeFilter').value) : '';
        try {
            resultBox.textContent = `æ­£åœ¨æŸ¥è¯¢é€‰ä¸­ MAC çš„æ•°æ®ï¼ˆå…± ${selected.length} ä¸ªï¼‰...`;
            resultBox.className = 'result-box text-primary';
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';
            // æ¸…ç©ºä¹‹å‰çš„å›¾è¡¨
            chartsContainer.innerHTML = '';
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            let allResults = [];
            for (const mac of selected) {
                const params = {};
                if (beaconMac) params.beacon_mac = beaconMac;
                if (startTime) params.start_time  = startTime;
                if (endTime) params.end_time  = endTime;
                console.log("è¯·æ±‚å‚æ•° paramsï¼š", params);
                const res = await axios.get(`${API_BASE}/by_mainmac/${mac}`, { params });
                if (res.data && Array.isArray(res.data)) {
                    // ä¸ºæ¯ä¸ªæ•°æ®é¡¹æ·»åŠ ä¸»è®¾å¤‡MACæ ‡è¯†
                    const dataWithMainMac = res.data.map(item => ({
                        ...item,
                        main_mac: mac
                    }));
                    allResults = allResults.concat(dataWithMainMac);
                }
            }
            if (allResults.length > 0) {
                // æŒ‰æ—¶é—´å€’åºæ’åˆ— (ä½¿ç”¨ timeUTC å­—æ®µ)
                allResults.sort((a, b) => {
                    const timeA = new Date(a.time_utc);
                    const timeB = new Date(b.time_utc);
                    return timeB - timeA;
                });
                // ä¿å­˜ç”¨äºæ˜¾ç¤ºçš„æ•°æ® (æœ€å¤š10æ¡)
                lastQueryData = allResults.slice(0, 5);
                lastDownloadData = allResults;
                resultBox.textContent = JSON.stringify(lastQueryData, null, 2);
                resultBox.className = 'result-box text-success';
                // å¦‚æœæ•°æ®è¶…è¿‡10æ¡ï¼Œæ˜¾ç¤ºæç¤º
                if (allResults.length > 10) {
                    const truncatedDiv = document.createElement('div');
                    truncatedDiv.className = 'data-truncated';
                    truncatedDiv.textContent = `ğŸ“¢ æ•°æ®å·²æˆªæ–­æ˜¾ç¤ºï¼Œå…± ${allResults.length} æ¡è®°å½•ã€‚`;
                    resultBox.appendChild(document.createElement('br'));
                    resultBox.appendChild(truncatedDiv);
                }
                // ç§»é™¤æ—§çš„ä¸‹è½½æŒ‰é’®ï¼Œæ·»åŠ æ–°çš„
                const downloadBtn = document.createElement('button');
                downloadBtn.id = 'downloadExcelBtn';
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = 'ğŸ“¥ ä¸‹è½½ä¸º Excel (ä½¿ç”¨ä¸Šæ¬¡æŸ¥è¯¢ç»“æœ)';
                downloadBtn.onclick = exportToExcel;
                downloadArea.innerHTML = '';
                downloadArea.appendChild(downloadBtn);
                downloadArea.style.display = 'block';
                // ä¸ºæ¯ä¸ªé€‰ä¸­çš„ä¸»è®¾å¤‡MACç”Ÿæˆå›¾è¡¨
                for (const mac of selected) {
                    const macData = allResults.filter(item => item.main_mac === mac);
                    if (macData.length > 0) {
                        createChartForMac(mac, macData);
                    }
                }
            } else {
                resultBox.textContent = `âœ… æŸ¥è¯¢æˆåŠŸï¼Œä½†æœªæ‰¾åˆ°ç›¸å…³è®°å½•ã€‚`;
                resultBox.className = 'result-box text-info';
                chartsContainer.innerHTML = '<div class="alert alert-info">æ²¡æœ‰æ•°æ®å¯ç”¨äºç”Ÿæˆå›¾è¡¨</div>';
            }
        } catch (err) {
            resultBox.textContent = `âŒ æŸ¥è¯¢å¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
            chartsContainer.innerHTML = '<div class="alert alert-danger">å›¾è¡¨ç”Ÿæˆå¤±è´¥</div>';
        }
    }
    // --- ä¸‹è½½é€‰ä¸­ MAC æ‰€æœ‰æ•°æ® (Excel) ---
    async function downloadSelectedMacsAll(btn) {
        const selectorContainer = getCurrentMacSelector(btn);
        const selected = getSelectedMacsFromSelector(selectorContainer);
        if (selected.length === 0) {
            alert('è¯·å…ˆåŠ è½½å¹¶å‹¾é€‰è‡³å°‘ä¸€ä¸ª MAC åœ°å€');
            return;
        }
        // è·å–é¢å¤–å‚æ•°
        const beaconMac = document.getElementById('beaconMacFilter').value.trim();
        const startTime = document.getElementById('startTimeFilter').value ? formatDateTimeForBackend(document.getElementById('startTimeFilter').value) : '';
        const endTime = document.getElementById('endTimeFilter').value ? formatDateTimeForBackend(document.getElementById('endTimeFilter').value) : '';
        // æ˜¾ç¤ºä¸‹è½½çŠ¶æ€
        downloadStatus.style.display = 'inline-block';
        downloadStatus.className = 'download-status downloading';
        downloadStatus.textContent = 'ğŸ“¥ æ­£åœ¨åå°ä¸‹è½½æ•°æ®...';
        try {
            let allResults = [];
            for (const mac of selected) {
                const params = {};
                if (beaconMac) params.beacon_mac = beaconMac;
                if (startTime) params.start_time = startTime;
                if (endTime) params.end_time = endTime;
                // ä½¿ç”¨ axios å®ä¾‹è¿›è¡Œè¯·æ±‚ï¼Œæ–¹ä¾¿ç®¡ç†
                const response = await axios.get(`${API_BASE}/by_mainmac/${mac}`, { params });
                if (response.data && Array.isArray(response.data)) {
                    // ä¸ºæ¯ä¸ªæ•°æ®é¡¹æ·»åŠ ä¸»è®¾å¤‡MACæ ‡è¯†
                    const dataWithMainMac = response.data.map(item => ({
                        ...item,
                        main_mac: mac
                    }));
                    allResults = allResults.concat(dataWithMainMac);
                }
            }
            if (allResults.length > 0) {
                // æŒ‰æ—¶é—´å€’åºæ’åˆ— (ä½¿ç”¨ timeUTC å­—æ®µ) - ä¸‹è½½æ—¶ä¹Ÿæ’åº
                allResults.sort((a, b) => {
                    const timeA = new Date(a.time_utc);
                    const timeB = new Date(b.time_utc);
                    return timeB - timeA;
                });
                // ä¿å­˜å®Œæ•´æ•°æ®ç”¨äºä¸‹è½½
                lastDownloadData = allResults;
                downloadStatus.className = 'download-status success';
                downloadStatus.textContent = `âœ… æ•°æ®ä¸‹è½½å®Œæˆ (${allResults.length} æ¡è®°å½•)ã€‚ç‚¹å‡» "ä¸‹è½½ä¸º Excel" æŒ‰é’®ä¿å­˜ã€‚`;
                // æ›´æ–°æˆ–åˆ›å»ºä¸‹è½½æŒ‰é’®
                let downloadBtn = document.getElementById('downloadExcelBtn');
                if (!downloadBtn) {
                    downloadBtn = document.createElement('button');
                    downloadBtn.id = 'downloadExcelBtn';
                    downloadBtn.className = 'btn btn-outline-primary';
                    downloadBtn.innerHTML = 'ğŸ“¥ ä¸‹è½½ä¸º Excel';
                    downloadBtn.onclick = exportToExcel;
                    downloadArea.innerHTML = '';
                    downloadArea.appendChild(downloadBtn);
                    downloadArea.style.display = 'block';
                } else {
                    downloadBtn.innerHTML = 'ğŸ“¥ ä¸‹è½½ä¸º Excel (ä½¿ç”¨æœ€æ–°ä¸‹è½½ç»“æœ)';
                    downloadBtn.onclick = exportToExcel;
                }
            } else {
                 downloadStatus.className = 'download-status success';
                 downloadStatus.textContent = 'âœ… ä¸‹è½½å®Œæˆï¼Œä½†æœªæ‰¾åˆ°ç›¸å…³è®°å½•ã€‚';
            }
        } catch (err) {
            console.error('ä¸‹è½½å¤±è´¥:', err);
            downloadStatus.className = 'download-status error';
            downloadStatus.textContent = `âŒ ä¸‹è½½å¤±è´¥ï¼š${err.message}`;
        }
    }
    // ä¸ºæŒ‡å®šä¸»è®¾å¤‡MACåˆ›å»º RSSI å›¾è¡¨
    function createChartForMac(mainMac, data) {
        // ... (ä¿æŒåŸæœ‰çš„ RSSI å›¾è¡¨ä»£ç ä¸å˜) ...
        // æŒ‰beacon_macåˆ†ç»„
        const beaconGroups = {};
        data.forEach(item => {
            const beaconMac = item.beacon_mac || 'æœªçŸ¥Beacon';
            if (!beaconGroups[beaconMac]) {
                beaconGroups[beaconMac] = [];
            }
            beaconGroups[beaconMac].push(item);
        });
        // åˆ›å»ºå›¾è¡¨å®¹å™¨
        const chartDiv = document.createElement('div');
        chartDiv.className = 'chart-container';
        const chartTitle = document.createElement('h5');
        chartTitle.className = 'chart-title';
        chartTitle.textContent = `ä¸»è®¾å¤‡ MAC: ${mainMac} - RSSIéšæ—¶é—´å˜åŒ–è¶‹åŠ¿`;
        chartDiv.appendChild(chartTitle);
        // æ·»åŠ å›¾è¡¨æ§åˆ¶æŒ‰é’®
        const chartControls = document.createElement('div');
        chartControls.className = 'chart-controls';
        const chartId = `rssi-chart-${mainMac.replace(/:/g, '').replace(/\./g, '')}`; // ç¡®ä¿å›¾è¡¨IDå”¯ä¸€
        chartControls.innerHTML = `
            <button class="btn btn-outline-secondary btn-sm" onclick="resetChartZoom('${chartId}')">ğŸ”„ é‡ç½®ç¼©æ”¾</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="zoomInChart('${chartId}')">ğŸ” æ”¾å¤§</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="zoomOutChart('${chartId}')">ğŸ” ç¼©å°</button>
        `;
        chartDiv.appendChild(chartControls);
        const canvasContainer = document.createElement('div');
        canvasContainer.className = 'chart-canvas-container';
        const canvas = document.createElement('canvas');
        canvas.id = chartId;
        canvasContainer.appendChild(canvas);
        chartDiv.appendChild(canvasContainer);
        chartsContainer.appendChild(chartDiv);
        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const datasets = [];
        const colors = [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(199, 199, 199, 1)',
            'rgba(83, 102, 199, 1)',
            'rgba(40, 159, 64, 1)',
            'rgba(199, 59, 199, 1)'
        ];
        let colorIndex = 0;
        // ä¸ºæ¯ä¸ªbeacon_macåˆ›å»ºæ•°æ®é›†
        Object.keys(beaconGroups).forEach(beaconMac => {
            const beaconData = beaconGroups[beaconMac];
            // æŒ‰æ—¶é—´æ’åº (ä½¿ç”¨ timeUTC å­—æ®µ)
            beaconData.sort((a, b) => {
                const timeA = new Date(a.time_utc);
                const timeB = new Date(b.time_utc);
                return timeA - timeB;
            });
            // ä¿®æ”¹è¿™é‡Œï¼šå¤„ç†æ—¶é—´æˆ³ï¼Œç§»é™¤æœ«å°¾çš„ .0
            const dataPoints = beaconData.map(item => {
                let timeStr = item.time_utc;
                if (timeStr.endsWith('.0')) {
                    timeStr = timeStr.slice(0, -2);
                }
                return {
                    x: new Date(timeStr),
                    y: item.rssi
                };
            });
            datasets.push({
                label: `Beacon: ${beaconMac}`,
                data: dataPoints,
                borderColor: colors[colorIndex % colors.length],
                showLine: false,
                backgroundColor: colors[colorIndex % colors.length].replace('1)', '0.2)'),
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false,
                tension: 0.1
            });
            colorIndex++;
        });
        // åˆ›å»ºå›¾è¡¨
        const ctx = canvas.getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'yyyy-MM-dd HH:mm:ss',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'HH:mm',
                                day: 'MM-dd HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'æ—¶é—´'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'RSSI (dBm)'
                        },
                        beginAtZero: false
                    }
                },
                plugins: {
                    title: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const rssi = context.parsed.y;
                                // ä¿®æ”¹è¿™é‡Œï¼šåœ¨ tooltip ä¸­ä¹Ÿç§»é™¤ .0
                                let timeStr = context.parsed.x.toISOString().replace('T', ' ');
                                if (timeStr.endsWith('.000Z')) {
                                    timeStr = timeStr.slice(0, -5);
                                }
                                return `${label}: RSSI=${rssi} dBm (æ—¶é—´: ${timeStr})`;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    },
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            },
            plugins: [ChartZoom] // å¯ç”¨ç¼©æ”¾æ’ä»¶
        });
        // ä¿å­˜å›¾è¡¨å®ä¾‹
        chartInstances.push(chart);
    }
    // å›¾è¡¨æ§åˆ¶å‡½æ•°
    function resetChartZoom(chartId) {
        const chart = Chart.getChart(chartId);
        if (chart) {
            chart.resetZoom();
        }
    }
    function zoomInChart(chartId) {
        const chart = Chart.getChart(chartId);
        if (chart) {
            chart.zoom(1.5);
        }
    }
    function zoomOutChart(chartId) {
        const chart = Chart.getChart(chartId);
        if (chart) {
            chart.zoom(0.75);
        }
    }
    // --- æŸ¥è¯¢é€‰ä¸­ MAC æœ€æ–° N æ¡ï¼ˆä»…é™å•é€‰ï¼‰---
    async function querySelectedMacLatest(btn) {
        const selectorContainer = getCurrentMacSelector(btn);
        const selected = getSelectedMacsFromSelector(selectorContainer);
        if (selected.length === 0) {
            alert('è¯·å…ˆåŠ è½½å¹¶å‹¾é€‰ä¸€ä¸ª MAC åœ°å€');
            return;
        }
        if (selected.length > 1) {
            alert('âš ï¸ æŸ¥è¯¢æœ€æ–° N æ¡ä»…æ”¯æŒå•é€‰ï¼Œè¯·åªå‹¾é€‰ä¸€ä¸ª MACã€‚');
            return;
        }
        const mac = selected[0];
        const num = document.getElementById('latestNumInput').value.trim();
        if (!num || isNaN(num) || num < 1) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¡æ•° Nï¼ˆâ‰¥1ï¼‰');
            return;
        }
        try {
            resultBox.textContent = `æ­£åœ¨æŸ¥è¯¢ MAC ${mac} æœ€æ–° ${num} æ¡æ•°æ®...`;
            resultBox.className = 'result-box text-primary';
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';
            const res = await axios.get(`${API_BASE}/by_mac/${mac}/${num}`);
            if (res.data && Array.isArray(res.data) && res.data.length > 0) {
                // ä¿å­˜å®Œæ•´æ•°æ®ç”¨äºä¸‹è½½
                lastQueryData = res.data; // è¿™é‡Œå¤ç”¨ lastQueryDataï¼Œä¹Ÿå¯ä»¥å•ç‹¬å®šä¹‰
                // æ˜¾ç¤ºæˆªæ–­åçš„æ•°æ®ï¼ˆæœ€å¤š10æ¡ï¼‰
                const displayData = res.data.slice(0, 10);
                resultBox.textContent = JSON.stringify(displayData, null, 2);
                resultBox.className = 'result-box text-success';
                // å¦‚æœæ•°æ®è¶…è¿‡10æ¡ï¼Œæ˜¾ç¤ºæç¤º
                if (res.data.length > 10) {
                    const truncatedDiv = document.createElement('div');
                    truncatedDiv.className = 'data-truncated';
                    truncatedDiv.textContent = `ğŸ“¢ æ•°æ®å·²æˆªæ–­æ˜¾ç¤ºï¼Œå…± ${res.data.length} æ¡è®°å½•ã€‚å®Œæ•´æ•°æ®å¯é€šè¿‡ Excel ä¸‹è½½ã€‚`;
                    resultBox.appendChild(document.createElement('br'));
                    resultBox.appendChild(truncatedDiv);
                }
                const downloadBtn = document.createElement('button');
                downloadBtn.id = 'downloadExcelBtn';
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = 'ğŸ“¥ ä¸‹è½½ä¸º Excel';
                downloadBtn.onclick = exportToExcel;
                downloadArea.innerHTML = '';
                downloadArea.appendChild(downloadBtn);
                downloadArea.style.display = 'block';
                // æ¸…ç©ºå›¾è¡¨åŒºåŸŸï¼ˆè¿™ä¸ªåŠŸèƒ½ä¸ç”Ÿæˆå›¾è¡¨ï¼‰
                chartsContainer.innerHTML = '';
                chartInstances.forEach(chart => chart.destroy());
                chartInstances = [];
            } else {
                resultBox.textContent = `âœ… æŸ¥è¯¢æˆåŠŸï¼Œä½†æœªæ‰¾åˆ° MAC ä¸º ${mac} çš„è®°å½•ã€‚`;
                resultBox.className = 'result-box text-info';
                chartsContainer.innerHTML = '';
                chartInstances.forEach(chart => chart.destroy());
                chartInstances = [];
            }
        } catch (err) {
            resultBox.textContent = `âŒ æŸ¥è¯¢å¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
            chartsContainer.innerHTML = '';
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
        }
    }
    // --- åˆ é™¤é€‰ä¸­ MAC æ‰€æœ‰æ•°æ® ---
    async function deleteSelectedMacsAll(btn) {
        const selectorContainer = getCurrentMacSelector(btn);
        const selected = getSelectedMacsFromSelector(selectorContainer);
        if (selected.length === 0) {
            alert('è¯·å…ˆåŠ è½½å¹¶å‹¾é€‰è‡³å°‘ä¸€ä¸ª MAC åœ°å€');
            return;
        }
        if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤ ${selected.length} ä¸ª MAC çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ
æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }
        try {
            resultBox.textContent = 'æ­£åœ¨åˆ é™¤é€‰ä¸­ MAC æ‰€æœ‰æ•°æ®...';
            resultBox.className = 'result-box text-primary';
            const results = [];
            for (const mac of selected) {
                try {
                    const res = await axios.delete(`${API_BASE}/delete/mac/${mac}`);
                    results.push(`âœ… ${mac}: ${res.data}`);
                    // ä»å…¨å±€ç¼“å­˜ä¸­ç§»é™¤
                    const index = globalAllMacs.indexOf(mac);
                    if (index > -1) {
                        globalAllMacs.splice(index, 1);
                    }
                } catch (err) {
                    results.push(`âŒ ${mac}: ${err.message}`);
                }
            }
            resultBox.textContent = results.join('');
            resultBox.className = 'result-box text-success';
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';
            // æ¸…ç©ºå›¾è¡¨
            chartsContainer.innerHTML = '';
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            // æ¸…ç©ºå½“å‰é€‰æ‹©å™¨çš„é€‰ä¸­çŠ¶æ€å’Œåˆ—è¡¨
            toggleSelectAllTags(selectorContainer.querySelector('.mac-selector-actions .btn:last-child'), false); // è§¦å‘æ¸…ç©º
            const tagsContainer = selectorContainer.querySelector('.mac-tags-container');
            tagsContainer.innerHTML = '<div class="text-muted">è¯·é‡æ–°åŠ è½½ MAC åˆ—è¡¨</div>';
            selectorContainer.querySelector('.mac-search-box input').disabled = true;
            selectorContainer.querySelector('.mac-search-box input').value = '';
        } catch (err) {
            resultBox.textContent = `âŒ æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
        }
    }
    // --- æ–°å¢ï¼šä¸€é”®å–æ¶ˆé€‰ä¸­å›¾è¡¨ä¸­æ‰€æœ‰å›¾ä¾‹ ---
    function toggleAllDatasets(chartId, visibility = false) {
        const chart = Chart.getChart(chartId);
        if (chart) {
            let allVisible = true;
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ•°æ®é›†éƒ½å¯è§ï¼Œæˆ–è€…å¼ºåˆ¶è®¾ç½®ä¸º visibility
            chart.data.datasets.forEach((dataset, index) => {
                const meta = chart.getDatasetMeta(index);
                if (meta.hidden !== true) { // å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªå¯è§ï¼Œåˆ™ allVisible ä¸º false
                     allVisible = false;
                }
            });
            const newState = visibility === true ? false : (allVisible === false); // å¦‚æœéƒ½æ˜¯å¯è§çš„ï¼Œåˆ™éšè—ï¼›å¦åˆ™æ˜¾ç¤ºï¼ˆæˆ–æ ¹æ® visibility å‚æ•°ï¼‰
            chart.data.datasets.forEach((dataset, index) => {
                const meta = chart.getDatasetMeta(index);
                meta.hidden = newState; // è®¾ç½®ä¸º true éšè—ï¼Œfalse æ˜¾ç¤º
            });
            chart.update(); // æ›´æ–°å›¾è¡¨
        }
    }
    // --- æ–°å¢ï¼šæŸ¥è¯¢è¿æ¥çŠ¶æ€åŠŸèƒ½å®ç° ---
    async function queryConnectionStatus(btn) {
        const selectorContainer = getCurrentMacSelector(btn);
        const selected = getSelectedMacsFromSelector(selectorContainer);
        if (selected.length === 0) {
            alert('è¯·å…ˆåŠ è½½å¹¶å‹¾é€‰è‡³å°‘ä¸€ä¸ª**åŸºç«™** MAC åœ°å€');
            return;
        }

        // æ¸…ç©ºç»“æœåŒº
        resultBox.textContent = `æ­£åœ¨æŸ¥è¯¢é€‰ä¸­åŸºç«™çš„è¿æ¥çŠ¶æ€ï¼ˆå…± ${selected.length} ä¸ªï¼‰...`;
        resultBox.className = 'result-box text-primary';
        downloadArea.style.display = 'none';
        downloadArea.innerHTML = '';
        chartsContainer.innerHTML = '';
        chartInstances.forEach(chart => chart.destroy());
        chartInstances = [];
        try {
            let allResults = [];
            for (const mainMac of selected) {
                const params = {};
                const res = await axios.get(`${API_BASE}/getworklog/${mainMac}`, { params });
                if (res.data && Array.isArray(res.data)) {
                    const dataWithMainMac = res.data.map(item => ({
                    ...item,
                    mainMac: item.mainMac || mainMac || 'unknown', // ä¼˜å…ˆç”¨è¿”å›çš„ï¼Œå¦åˆ™ç”¨æŸ¥è¯¢çš„
                    beacon: item.beaconMac,        // æ—§é€»è¾‘ç”¨ beaconï¼Œç»Ÿä¸€å­—æ®µ
                    stability: item.curStatus      // æ—§é€»è¾‘ç”¨ stabilityï¼Œç»Ÿä¸€å­—æ®µ
                }));
                    allResults = allResults.concat(dataWithMainMac);
                }
            }
            if (allResults.length > 0) {
                // ä¿å­˜ç”¨äºæ˜¾ç¤ºçš„æ•°æ®ï¼ˆæ˜¾ç¤ºå‰10æ¡ï¼‰
                const filteredData = allResults.map(item => ({
                    baseStation: item.baseStation,
                    beaconMac: item.beaconMac,
                    endTime: item.endTime,
                    endLat: item.endLat,
                    endLon: item.endLon,
                    curStatus: item.curStatus
                }));
                lastQueryData = filteredData.slice(0, 5);
                lastDownloadData = filteredData;
                resultBox.textContent = JSON.stringify(lastQueryData, null, 2);
                resultBox.className = 'result-box text-success';
                if (allResults.length > 10) {
                    const truncatedDiv = document.createElement('div');
                    truncatedDiv.className = 'data-truncated';
                    truncatedDiv.textContent = `ğŸ“¢ æ•°æ®å·²æˆªæ–­æ˜¾ç¤ºï¼Œå…± ${allResults.length} æ¡è®°å½•ã€‚`;
                    resultBox.appendChild(document.createElement('br'));
                    resultBox.appendChild(truncatedDiv);
                }
                // ç§»é™¤æ—§çš„ä¸‹è½½æŒ‰é’®ï¼Œæ·»åŠ æ–°çš„ï¼ˆæŸ¥è¯¢ç»“æœä¹Ÿå¯ä»¥ä¸‹è½½ï¼‰
                const downloadBtn = document.createElement('button');
                downloadBtn.id = 'downloadExcelBtn';
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = 'ğŸ“¥ ä¸‹è½½ä¸º Excel (çŠ¶æ€æŸ¥è¯¢ç»“æœ)';
                downloadBtn.onclick = exportToStatusExcel; // ä½¿ç”¨æ–°çš„ä¸‹è½½å‡½æ•°
                downloadArea.innerHTML = '';
                downloadArea.appendChild(downloadBtn);
                downloadArea.style.display = 'block';
                // ä¸ºæ¯ä¸ªé€‰ä¸­çš„åŸºç«™ MAC ç”Ÿæˆå›¾è¡¨
                for (const mainMac of selected) {
                    const macData = allResults.filter(item => item.mainMac === mainMac);
                    if (macData.length > 0) {
                        createStatusChartForMainMac(mainMac, macData);
                    }
                }
            } else {
                resultBox.textContent = `âœ… æŸ¥è¯¢æˆåŠŸï¼Œä½†æœªæ‰¾åˆ°ç›¸å…³è¿æ¥çŠ¶æ€è®°å½•ã€‚`;
                resultBox.className = 'result-box text-info';
                chartsContainer.innerHTML = '<div class="alert alert-info">æ²¡æœ‰æ•°æ®å¯ç”¨äºç”Ÿæˆè¿æ¥çŠ¶æ€å›¾è¡¨</div>';
            }
        } catch (err) {
            resultBox.textContent = `âŒ æŸ¥è¯¢å¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
            chartsContainer.innerHTML = '<div class="alert alert-danger">è¿æ¥çŠ¶æ€å›¾è¡¨ç”Ÿæˆå¤±è´¥</div>';
        }
    }
    // --- ä¿®æ”¹ï¼šæŸ¥è¯¢åŠ¨åŠ›è½¦å·¥ä½œæ—¥å¿—æ—¶é—´èŒƒå›´ ---
    async function queryWorkLogTimeRange(btn) {
        const selectorContainer = getCurrentMacSelector(btn);
        const selected = getSelectedMacsFromSelector(selectorContainer);
        if (selected.length === 0) {
            alert('è¯·å…ˆåŠ è½½å¹¶å‹¾é€‰è‡³å°‘ä¸€ä¸ª**åŠ¨åŠ›è½¦** MAC åœ°å€');
            return;
        }

        const beaconMacs = getBeaconInputs(); // è·å–æ‰€æœ‰ Beacon MAC è¾“å…¥å€¼
        const startTime = document.getElementById('workLogStartTimeFilter').value ? formatDateTimeForBackend(document.getElementById('workLogStartTimeFilter').value) : '';
        const endTime = document.getElementById('workLogEndTimeFilter').value ? formatDateTimeForBackend(document.getElementById('workLogEndTimeFilter').value) : '';

        // æ¸…ç©ºç»“æœåŒº
        resultBox.textContent = `æ­£åœ¨æŸ¥è¯¢é€‰ä¸­åŠ¨åŠ›è½¦çš„å·¥ä½œæ—¥å¿—ï¼ˆå…± ${selected.length} ä¸ªï¼‰ï¼ŒBeacon MACs: [${beaconMacs.join(', ')}]...`;
        resultBox.className = 'result-box text-primary';
        downloadArea.style.display = 'none';
        downloadArea.innerHTML = '';
        chartsContainer.innerHTML = ''; // æ­¤åŠŸèƒ½ä¸ç”Ÿæˆå›¾è¡¨
        chartInstances.forEach(chart => chart.destroy());
        chartInstances = [];

        try {
            let allResults = [];
            for (const mainMac of selected) {
                // å¦‚æœæ²¡æœ‰æŒ‡å®šBeacon MACï¼Œåˆ™è‡³å°‘ç”¨ä¸€ä¸ªç©ºå­—ç¬¦ä¸²è¿›è¡Œä¸€æ¬¡æŸ¥è¯¢
                const beaconsToQuery = beaconMacs.length > 0 ? beaconMacs : [''];
                for (const beaconMac of beaconsToQuery) {
                    const params = {};
                    if (beaconMac) params.beacon_mac = beaconMac; // ä»…åœ¨éç©ºæ—¶æ·»åŠ 
                    if (startTime) params.start_time = startTime;
                    if (endTime) params.end_time = endTime;

                    console.log(`è¯·æ±‚å‚æ•° for ${mainMac} & ${beaconMac || 'N/A'}:`, params);

                    try {
                        const res = await axios.get(`${API_BASE}/getworklogtimerange/${mainMac}`, { params });
                        if (res.data && Array.isArray(res.data)) {
                            const dataWithMainMac = res.data.map(item => ({
                                ...item,
                                mainMac: mainMac, // æ·»åŠ ä¸»MACæ ‡è¯†
                                queriedBeaconMac: beaconMac || 'N/A' // æ·»åŠ æŸ¥è¯¢æ—¶ä½¿ç”¨çš„Beacon MACæ ‡è¯†
                            }));
                            allResults = allResults.concat(dataWithMainMac);
                        } else {
                            console.warn(`API for ${mainMac} & ${beaconMac || 'N/A'} returned non-array data:`, res.data);
                        }
                    } catch (err) {
                        console.error(`æŸ¥è¯¢ ${mainMac} & ${beaconMac || 'N/A'} æ—¶å‡ºé”™:`, err);
                        // å¯ä»¥é€‰æ‹©åœ¨è¿™é‡Œæ”¶é›†é”™è¯¯ä¿¡æ¯ï¼Œæˆ–è€…è·³è¿‡
                        // ä¾‹å¦‚: alert(`æŸ¥è¯¢ ${mainMac} & ${beaconMac || 'N/A'} æ—¶å‡ºé”™: ${err.message}`);
                    }
                }
            }
            if (allResults.length > 0) {
                // ä¿å­˜ç”¨äºæ˜¾ç¤ºçš„æ•°æ®ï¼ˆæ˜¾ç¤ºå‰10æ¡ï¼‰
                lastQueryData = allResults.slice(0, 10);
                lastDownloadData = allResults; // ä¿å­˜å®Œæ•´æ•°æ®ç”¨äºä¸‹è½½
                resultBox.textContent = JSON.stringify(lastQueryData, null, 2);
                resultBox.className = 'result-box text-success';
                if (allResults.length > 10) {
                    const truncatedDiv = document.createElement('div');
                    truncatedDiv.className = 'data-truncated';
                    truncatedDiv.textContent = `ğŸ“¢ æ•°æ®å·²æˆªæ–­æ˜¾ç¤ºï¼Œå…± ${allResults.length} æ¡è®°å½•ã€‚`;
                    resultBox.appendChild(document.createElement('br'));
                    resultBox.appendChild(truncatedDiv);
                }
                // æ·»åŠ ä¸‹è½½æŒ‰é’®
                const downloadBtn = document.createElement('button');
                downloadBtn.id = 'downloadWorkLogExcelBtn';
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = 'ğŸ“¥ ä¸‹è½½ä¸º Excel (å·¥ä½œæ—¥å¿—)';
                downloadBtn.onclick = exportToWorkLogExcel;
                downloadArea.innerHTML = '';
                downloadArea.appendChild(downloadBtn);
                downloadArea.style.display = 'block';
            } else {
                resultBox.textContent = `âœ… æŸ¥è¯¢æˆåŠŸï¼Œä½†æœªæ‰¾åˆ°ç›¸å…³å·¥ä½œæ—¥å¿—è®°å½•ã€‚`;
                resultBox.className = 'result-box text-info';
            }
        } catch (err) {
            console.error("æŸ¥è¯¢å·¥ä½œæ—¥å¿—æ—¶å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯:", err);
            resultBox.textContent = `âŒ æŸ¥è¯¢å¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
        }
    }
    // --- æ–°å¢ï¼šä¸‹è½½å·¥ä½œæ—¥å¿— Excel ---
    function exportToWorkLogExcel() {
        if (!lastDownloadData || !Array.isArray(lastDownloadData) || lastDownloadData.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å·¥ä½œæ—¥å¿—æ•°æ®');
            return;
        }
        // æ˜ å°„æ•°æ®å­—æ®µä»¥é€‚åº” Excel è¾“å‡º
        const mappedData = lastDownloadData.map(item => ({
            "åŠ¨åŠ›è½¦åŸºç«™åœ°å€": item.mainMac || '',
            "æ— åŠ¨åŠ›è½¦ä¿¡æ ‡åœ°å€": item.beaconMac || '',
            "è½¬å˜æ—¶é—´": item.endTime || '',
            "ç»‘å®šçŠ¶æ€": item.curStatus || '',
            // æ ¹æ®åç«¯ BindingTime ç±»çš„å®é™…å­—æ®µè°ƒæ•´
        }));
        const worksheet = XLSX.utils.json_to_sheet(mappedData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "å·¥ä½œæ—¥å¿—æ•°æ®");
        XLSX.writeFile(workbook, `å·¥ä½œæ—¥å¿—æ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
    // å…¨å±€é¢œè‰²ç®¡ç†å™¨
    const ColorManager = {
        usedColors: new Map(), // å­˜å‚¨å·²ä½¿ç”¨çš„beaconMacå¯¹åº”çš„é¢œè‰²
        availableColors: [
            'rgba(40, 167, 69, 0.2)',
            'rgba(220, 53, 69, 0.2)',
            'rgba(108, 117, 128, 0.2)',
            'rgba(255, 193, 7, 0.2)',
            'rgba(13, 110, 253, 0.2)',
            'rgba(255, 139, 0, 0.2)',
            'rgba(154, 205, 50, 0.2)',
            'rgba(75, 0, 130, 0.2)',
            'rgba(255, 20, 147, 0.4)',
            'rgba(30, 144, 255, 0.4)',
            'rgba(255, 105, 180, 0.4)',
            'rgba(50, 205, 50, 0.4)',
            'rgba(255, 69, 0, 0.4)',
            'rgba(123, 104, 238, 0.4)',
            'rgba(255, 140, 0, 0.4)',
            'rgba(0, 255, 127, 0.4)',
            'rgba(70, 130, 180, 0.4)',
            'rgba(218, 165, 32, 0.4)',
            'rgba(139, 0, 139, 0.4)',
            'rgba(255, 192, 203, 0.4)'
        ],
        // ä¸ºç‰¹å®šçš„beaconMacåˆ†é…é¢œè‰²
        getColor: function(beaconMac) {
            // å¦‚æœè¿™ä¸ªbeaconMacå·²ç»æœ‰é¢œè‰²äº†ï¼Œç›´æ¥è¿”å›
            if (this.usedColors.has(beaconMac)) {
                return this.usedColors.get(beaconMac);
            }
            // æŸ¥æ‰¾ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„é¢œè‰²
            for (let i = 0; i < this.availableColors.length; i++) {
                const color = this.availableColors[i];
                // æ£€æŸ¥è¿™ä¸ªé¢œè‰²æ˜¯å¦å·²è¢«å…¶ä»–beaconMacä½¿ç”¨
                const isColorUsed = Array.from(this.usedColors.values()).includes(color);
                if (!isColorUsed) {
                    this.usedColors.set(beaconMac, color);
                    return color;
                }
            }
            // å¦‚æœæ‰€æœ‰é¢„å®šä¹‰é¢œè‰²éƒ½ç”¨å®Œäº†ï¼Œç”Ÿæˆä¸€ä¸ªéšæœºé¢œè‰²
            return this.generateRandomColor(beaconMac);
        },
        // ç”ŸæˆåŸºäºbeaconMacçš„ç¡®å®šæ€§éšæœºé¢œè‰²
        generateRandomColor: function(beaconMac) {
            // åŸºäºbeaconMacçš„å“ˆå¸Œå€¼ç”Ÿæˆç¡®å®šæ€§çš„é¢œè‰²
            let hash = 0;
            for (let i = 0; i < beaconMac.length; i++) {
                hash = beaconMac.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = Math.abs(hash) % 360;
            const saturation = 70 + (Math.abs(hash * 3) % 30); // 70-100%
            const lightness = 40 + (Math.abs(hash * 7) % 30);  // 40-70%
            return `hsla(${hue}, ${saturation}%, ${lightness}%, 0.4)`;
        },
        // é‡ç½®é¢œè‰²ç®¡ç†å™¨ï¼ˆå¯é€‰ï¼‰
        reset: function() {
            this.usedColors.clear();
        }
    };

    // --- æŸ¥è¯¢æ”¶è´¹ ---
    async function queryMoney(btn) {
        const selectorContainer = getCurrentMacSelector(btn);
        const selected = getSelectedMacsFromSelector(selectorContainer);
        if (selected.length === 0) {
            alert('è¯·å…ˆåŠ è½½å¹¶å‹¾é€‰è‡³å°‘ä¸€ä¸ªä¸»è®¾å¤‡ MAC');
            return;
        }

        const beaconMac = document.getElementById('moneyBeaconMac').value.trim();
        const startTime = document.getElementById('moneyStartTime').value ? formatDateTimeForBackend(document.getElementById('moneyStartTime').value) : '';
        const endTime = document.getElementById('moneyEndTime').value ? formatDateTimeForBackend(document.getElementById('moneyEndTime').value) : '';

        resultBox.textContent = `æ­£åœ¨æŸ¥è¯¢ ${selected.length} ä¸ªè®¾å¤‡çš„æ”¶è´¹æ•°æ®...`;
        resultBox.className = 'result-box text-primary';
        downloadArea.style.display = 'none';
        downloadArea.innerHTML = '';
        chartsContainer.innerHTML = ''; // ä¸ç”Ÿæˆå›¾è¡¨
        chartInstances.forEach(chart => chart.destroy());
        chartInstances = [];

        try {
            let allResults = [];
            for (const mainMac of selected) {
                const params = {};
                if (beaconMac) params.beacon_mac = beaconMac;
                if (startTime) params.start_time = startTime;
                if (endTime) params.end_time = endTime;

                const res = await axios.get(`${API_BASE}/getmoney`, {
                    params: { ...params, mainMac: mainMac }
                });

                if (res.data && Array.isArray(res.data)) {
                    // ä¸ºæ¯æ¡è®°å½•æ·»åŠ  mainMac å­—æ®µä¾¿äºè¯†åˆ«
                    const dataWithMainMac = res.data.map(item => ({
                        ...item,
                        mainMac: mainMac
                    }));
                    allResults = allResults.concat(dataWithMainMac);
                }
            }

            if (allResults.length > 0) {
                lastQueryData = allResults.slice(0, 20); // æ˜¾ç¤ºå‰20æ¡
                lastDownloadData = allResults;

                // åˆ›å»ºè¡¨æ ¼æ˜¾ç¤ºæ•°æ®
                const table = createMoneyTable(allResults);
                resultBox.innerHTML = '';
                resultBox.appendChild(table);
                resultBox.className = 'result-box text-success';

                if (allResults.length > 20) {
                    const truncatedDiv = document.createElement('div');
                    truncatedDiv.className = 'data-truncated';
                    truncatedDiv.textContent = `ğŸ“¢ æ•°æ®å·²æˆªæ–­æ˜¾ç¤ºï¼Œå…± ${allResults.length} æ¡è®°å½•ã€‚`;
                    resultBox.appendChild(truncatedDiv);
                }

                // æ·»åŠ ä¸‹è½½æŒ‰é’®
                const downloadBtn = document.createElement('button');
                downloadBtn.id = 'downloadMoneyExcelBtn';
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = 'ğŸ“¥ ä¸‹è½½æ”¶è´¹æ˜ç»†ä¸º Excel';
                downloadBtn.onclick = exportToMoneyExcel;
                downloadArea.innerHTML = '';
                downloadArea.appendChild(downloadBtn);
                downloadArea.style.display = 'block';
            } else {
                resultBox.textContent = 'âœ… æŸ¥è¯¢æˆåŠŸï¼Œä½†æœªæ‰¾åˆ°æ”¶è´¹è®°å½•ã€‚';
                resultBox.className = 'result-box text-info';
            }
        } catch (err) {
            console.error('æŸ¥è¯¢æ”¶è´¹å¤±è´¥:', err);
            resultBox.textContent = `âŒ æŸ¥è¯¢å¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
        }
    }

    // åˆ›å»ºæ”¶è´¹æ•°æ®è¡¨æ ¼
    function createMoneyTable(data) {
        const table = document.createElement('table');
        table.className = 'money-table';
        table.style.cssText = `
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-family: Arial, sans-serif;
        `;

        // åˆ›å»ºè¡¨å¤´
        const thead = document.createElement('thead');
        thead.style.backgroundColor = '#f8f9fa';
        thead.style.borderBottom = '2px solid #dee2e6';

        const headerRow = document.createElement('tr');
        const headers = ['ç‰µå¼•åŠ¨åŠ›è½¦', 'æ— åŠ¨åŠ›è½¦', 'è´¹ç”¨(å…ƒ)'];

        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            th.style.cssText = `
                padding: 12px 8px;
                text-align: left;
                font-weight: bold;
                border-bottom: 2px solid #dee2e6;
            `;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // åˆ›å»ºè¡¨ä½“
        const tbody = document.createElement('tbody');

        data.forEach((item, index) => {
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid #dee2e6';

            if (index % 2 === 0) {
                row.style.backgroundColor = '#ffffff';
            } else {
                row.style.backgroundColor = '#f8f9fa';
            }


            // ä¸»è®¾å¤‡ MAC
            const mainMacCell = document.createElement('td');
            mainMacCell.textContent = item.mainMac || '';
            mainMacCell.style.padding = '8px';

            // Beacon MAC
            const beaconMacCell = document.createElement('td');
            beaconMacCell.textContent = item.beaconMac || '';
            beaconMacCell.style.padding = '8px';

            // è´¹ç”¨
            const moneyCell = document.createElement('td');
            moneyCell.textContent = item.money || '0';
            moneyCell.style.padding = '8px';

            row.appendChild(mainMacCell);
            row.appendChild(beaconMacCell);
            row.appendChild(moneyCell);

            tbody.appendChild(row);
        });

        table.appendChild(tbody);

        return table;
    }

    // --- å¯¼å‡ºæ”¶è´¹æ•°æ®ä¸º Excel ---
    function exportToMoneyExcel() {
        if (!lastDownloadData || !Array.isArray(lastDownloadData) || lastDownloadData.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ”¶è´¹æ•°æ®');
            return;
        }

        const mappedData = lastDownloadData.map(item => ({
            "ç‰µå¼•è½¦": item.mainMac || '',
            "æ— åŠ¨åŠ›è½¦": item.beaconMac || '',
            "è´¹ç”¨(å…ƒ)": item.money || 0
        }));

        const worksheet = XLSX.utils.json_to_sheet(mappedData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "æ”¶è´¹æ˜ç»†");
        XLSX.writeFile(workbook, `æ”¶è´¹æ˜ç»†_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
    /**
     * ä¸ºå•ä¸ªä¸»MACåœ°å€åˆ›å»ºä¸€ä¸ªè¿æ¥çŠ¶æ€éšæ—¶é—´å˜åŒ–çš„å›¾è¡¨ã€‚
     * @param {string} mainMac - ä¸»MACåœ°å€.
     * @param {Array<Object>} data - åŒ…å«çŠ¶æ€ä¿¡æ¯çš„æ•°ç»„.
     */
    function createStatusChartForMainMac(mainMac, data) {
        // --- 1. æ•°æ®é¢„å¤„ç† ---
        // æŒ‰ beacon_mac åˆ†ç»„
        const beaconGroups = {};
        data.forEach(item => {
            const beaconMac = item.beacon || item.beaconMac || 'æœªçŸ¥Beacon';
            if (!beaconGroups[beaconMac]) {
                beaconGroups[beaconMac] = [];
            }
            beaconGroups[beaconMac].push(item);
        });
        // --- 2. åˆ›å»ºå›¾è¡¨å®¹å™¨ ---
        const chartDiv = document.createElement('div');
        chartDiv.className = 'chart-container';
        const chartTitle = document.createElement('h5');
        chartTitle.className = 'chart-title';
        chartTitle.textContent = `åŸºç«™ MAC: ${mainMac} - è¿æ¥çŠ¶æ€éšæ—¶é—´å˜åŒ–è¶‹åŠ¿`;
        chartDiv.appendChild(chartTitle);
        // æ·»åŠ å›¾è¡¨æ§åˆ¶æŒ‰é’®
        const chartControls = document.createElement('div');
        chartControls.className = 'chart-controls';
        const chartId = `status-chart-${mainMac.replace(/:/g, '').replace(/\./g, '')}`;
        chartControls.innerHTML = `
            <button class="btn btn-outline-secondary btn-sm" onclick="resetChartZoom('${chartId}')">ğŸ”„ é‡ç½®ç¼©æ”¾</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="zoomInChart('${chartId}')">ğŸ” æ”¾å¤§</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="zoomOutChart('${chartId}')">ğŸ” ç¼©å°</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleAllDatasets('${chartId}', true)">ğŸ‘ï¸ æ˜¾ç¤ºå…¨éƒ¨</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleAllDatasets('${chartId}', false)">ğŸ‘ï¸ éšè—å…¨éƒ¨</button>
        `;
        chartDiv.appendChild(chartControls);
        const canvasContainer = document.createElement('div');
        canvasContainer.className = 'chart-canvas-container';
        const canvas = document.createElement('canvas');
        canvas.id = chartId;
        canvasContainer.appendChild(canvas);
        chartDiv.appendChild(canvasContainer);
        // å‡è®¾ chartsContainer å·²ç»åœ¨å¤–éƒ¨å®šä¹‰
        if (typeof chartsContainer !== 'undefined') {
            chartsContainer.appendChild(chartDiv);
        } else {
            console.error("chartsContainer is not defined.");
            document.body.appendChild(chartDiv);
        }
        // --- 3. å‡†å¤‡å›¾è¡¨æ•°æ® ---
        const datasets = [];
        const statusValueMap = {
            'Bound': 3,
            'Unbound': 1,
            'In Transition': 2
        };
        // ä¸ºæ¯ä¸ª beacon_mac åˆ›å»ºæ•°æ®é›†
        Object.keys(beaconGroups).forEach((beaconMac) => {
            const beaconData = beaconGroups[beaconMac];
            // æŒ‰æ—¶é—´æ’åº (ä½¿ç”¨ endTime å­—æ®µ)
            beaconData.sort((a, b) => {
                const timeA = new Date(a.endTime);
                const timeB = new Date(b.endTime);
                return timeA - timeB;
            });
            // å¤„ç†æ—¶é—´æˆ³ï¼Œç¡®ä¿æ—¶é—´å¯¹è±¡æœ‰æ•ˆ
            const dataPoints = beaconData.map(item => {
                // ä½¿ç”¨ endTime å­—æ®µä½œä¸ºæ—¶é—´
                const timeValue = new Date(item.endTime);
                // æ£€æŸ¥æ—¶é—´æ˜¯å¦æœ‰æ•ˆ
                if (isNaN(timeValue.getTime())) {
                    console.warn(`æ— æ•ˆçš„æ—¶é—´æˆ³: ${item.endTime}`, item);
                    return null; // è·³è¿‡æ— æ•ˆæ•°æ®ç‚¹
                }
                // å°†çŠ¶æ€å­—ç¬¦ä¸²æ˜ å°„ä¸ºæ•°å€¼
                const statusValue = statusValueMap[item.stability || item.curStatus] || 0; // é»˜è®¤å€¼0è¡¨ç¤ºæœªçŸ¥çŠ¶æ€
                // è·³è¿‡çŠ¶æ€å€¼ä¸º0çš„æ•°æ®ç‚¹
                if (statusValue === 0) {
                    return null;
                }
                return {
                    x: timeValue,
                    y: statusValue // ä½¿ç”¨æ•°å€¼è€Œéå­—ç¬¦ä¸²
                };
            }).filter(point => point !== null); // è¿‡æ»¤æ‰æ— æ•ˆæ•°æ®ç‚¹å’ŒçŠ¶æ€ä¸º0çš„æ•°æ®ç‚¹
            // ä½¿ç”¨é¢œè‰²ç®¡ç†å™¨è·å–é¢œè‰²
            const color = ColorManager.getColor(beaconMac);
            datasets.push({
                label: `Beacon: ${beaconMac}`,
                data: dataPoints,
                borderColor: color,
                showLine: false,
                backgroundColor: color,
                borderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 4,
                fill: false,
                tension: 0.1,
                yAxisID: 'y'
            });
        });
        // --- 4. åˆ›å»ºå›¾è¡¨ ---
        const ctx = canvas.getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'yyyy-MM-dd HH:mm:ss',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'HH:mm',
                                day: 'MM-dd HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'æ—¶é—´'
                        }
                    },
                    y: {
                        id: 'y',
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'è¿æ¥çŠ¶æ€'
                        },
                        afterBuildTicks: function(scale) {
                            scale.ticks = [
                                { value: 1, label: 'æœªç»‘å®š (Unbound)' },
                                { value: 2, label: 'è½¬æ¢ä¸­ (In Transition)' },
                                { value: 3, label: 'å·²ç»‘å®š (Bound)' }
                            ];
                        },
                        min: 0.8,
                        max: 3.2,
                        ticks: {
                            callback: function(value) {
                                if (value === 1) return 'æœªç»‘å®š (Unbound)';
                                if (value === 2) return 'è½¬æ¢ä¸­ (In Transition)';
                                if (value === 3) return 'å·²ç»‘å®š (Bound)';
                                return '';
                            }
                        },
                        grid: {
                            drawOnChartArea: true,
                            color: function(context) {
                                if (context.tick && [1, 2, 3].includes(context.tick.value)) {
                                    return 'rgba(0, 0, 0, 0.15)';
                                }
                                return 'rgba(0, 0, 0, 0)';
                            },
                            lineWidth: 1,
                            borderDash: [5, 5],
                        },
                        position: 'left',
                    }
                },
                plugins: {
                    title: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const statusValue = context.parsed.y;
                                // è·å–çŠ¶æ€åç§°
                                let statusName = '';
                                if (statusValue === 1) statusName = 'æœªç»‘å®š (Unbound)';
                                else if (statusValue === 2) statusName = 'è½¬æ¢ä¸­ (In Transition)';
                                else if (statusValue === 3) statusName = 'å·²ç»‘å®š (Bound)';
                                else statusName = 'æœªçŸ¥';
                                // æ ¼å¼åŒ–æ—¶é—´
                                let timeStr = new Date(context.parsed.x).toLocaleString();
                                return `${label}: çŠ¶æ€=${statusName} (æ—¶é—´: ${timeStr})`;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            // è‡ªå®šä¹‰å›¾ä¾‹é¢œè‰²
                            generateLabels: function(chart) {
                                const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                return original.map((label, index) => {
                                    const dataset = chart.data.datasets[index];
                                    const beaconMac = dataset.label.replace('Beacon: ', '');
                                    label.fillStyle = ColorManager.getColor(beaconMac);
                                    label.strokeStyle = ColorManager.getColor(beaconMac);
                                    return label;
                                });
                            }
                        }
                    },
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
            }
        });
        // --- 5. ä¿å­˜å›¾è¡¨å®ä¾‹ ---
        if (typeof chartInstances !== 'undefined') {
            chartInstances.push(chart);
        } else {
            console.error("chartInstances array is not defined.");
        }
        return chart;
    }
    // --- æ–°å¢ï¼šä¸‹è½½çŠ¶æ€æŸ¥è¯¢ç»“æœ Excel ---
    function exportToStatusExcel() {
        if (!lastQueryData || !Array.isArray(lastQueryData) || lastQueryData.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
            return;
        }
        const mappedData = lastDownloadData.map(item => ({
            "åŸºç«™ MAC": item.baseStation || '',
            "Beacon MAC": item.beaconMac || '',
            "ç»“æŸæ—¶é—´": item.endTime || '',
            "è¿æ¥çŠ¶æ€": item.curStatus || '',
            "ç»ˆç‚¹çº¬åº¦": item.endLat || 0,
            "ç»ˆç‚¹ç»åº¦": item.endLon || 0
            // å¯æ ¹æ®éœ€è¦æ·»åŠ  startTime/startLat/startLonï¼ˆå¦‚æœåç«¯è¿”å›ï¼‰
        }));
        const worksheet = XLSX.utils.json_to_sheet(mappedData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "è¿æ¥çŠ¶æ€æ•°æ®");
        XLSX.writeFile(workbook, `è¿æ¥çŠ¶æ€æ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
</script>
</body>

</html>

